<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Agent - –ß–∞—Ç</title>
    
    <!-- –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/chat.css">
</head>
<body>
    <div class="app-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">
                    <span class="title-icon">ü§ñ</span>
                    <span class="title-text">AI Code Agent</span>
                </h1>
                <div class="header-actions">
                    <button class="icon-btn" id="searchToggle" title="–ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ (Ctrl+F)">
                        <span>üîç</span>
                    </button>
                    <button class="icon-btn" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É (Ctrl+/)">
                        <span class="theme-icon">üåô</span>
                    </button>
                    <nav class="header-nav">
                        <a href="/ide" class="nav-btn">
                            <span>üíª</span>
                            <span>IDE</span>
                        </a>
                        <a href="/settings" class="nav-btn">
                            <span>‚öôÔ∏è</span>
                            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        </a>
                    </nav>
                    <div class="status-indicator">
                        <span class="status-dot" id="statusDot"></span>
                        <span class="status-text" id="statusText">–ì–æ—Ç–æ–≤</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- –ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ -->
        <div class="search-bar" id="searchBar" style="display: none;">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö... (Enter –¥–ª—è –ø–æ–∏—Å–∫–∞, Esc –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è)">
                <button class="search-btn" id="searchPrev" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ">‚ñ≤</button>
                <button class="search-btn" id="searchNext" title="–°–ª–µ–¥—É—é—â–µ–µ">‚ñº</button>
                <span class="search-count" id="searchCount"></span>
                <button class="search-close" id="searchClose" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message">
                    <div class="welcome-icon">üëã</div>
                    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                    <p>–Ø –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –≤–æ–ø—Ä–æ—Å –æ –∫–æ–¥–µ, –∏ —è –ø–æ–º–æ–≥—É –≤–∞–º!</p>
                    <div class="welcome-features">
                        <div class="feature-item">
                            <span class="feature-icon">‚ú®</span>
                            <span>–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üìù</span>
                            <span>Markdown —Ä–∞–∑–º–µ—Ç–∫–∞ (–∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, —Ç–∞–±–ª–∏—Ü—ã)</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üîç</span>
                            <span>–ê–Ω–∞–ª–∏–∑ –∏ —É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–¥–∞</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="userInput" 
                        class="chat-input"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å –æ –∫–æ–¥–µ..."
                        rows="1"
                    ></textarea>
                    <div class="input-actions">
                        <button class="action-btn secondary" id="clearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">
                            <span>üóëÔ∏è</span>
                        </button>
                        <button class="action-btn primary" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å (Enter)">
                            <span>üì§</span>
                        </button>
                    </div>
                </div>
                <div class="input-hint">
                    <span>–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏</span>
                </div>
            </div>
        </main>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="/static/js/common.js"></script>
    <script src="/static/js/websocket.js"></script>
    
    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearBtn = document.getElementById('clearBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        let ws = null;
        let accumulatedContent = '';
        let currentMessageElement = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
        function connectWebSocket() {
            ws = new WebSocketClient('/ws', {
                onOpen: () => {
                    updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                    console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                },
                onMessage: (data) => {
                    handleWebSocketMessage(data);
                },
                onError: (error) => {
                    console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                    updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                },
                onClose: () => {
                    updateStatus('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'connecting');
                },
                onReconnect: (attempts) => {
                    updateStatus(`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... (${attempts})`, 'connecting');
                }
            });
            ws.connect();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
        function handleWebSocketMessage(data) {
            if (data.type === 'chunk') {
                appendToMessage(data.content);
            } else if (data.type === 'done') {
                finishMessage();
            } else if (data.type === 'cleared') {
                clearChatUI();
            } else if (data.type === 'error') {
                showError(data.content);
                finishMessage();
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
        function appendToMessage(content) {
            if (!currentMessageElement) {
                currentMessageElement = createMessageElement('assistant', '');
                accumulatedContent = '';
            }
            accumulatedContent += content;
            const contentDiv = currentMessageElement.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.innerHTML = MarkdownProcessor.parse(accumulatedContent);
                MarkdownProcessor.highlightCode(contentDiv);
                scrollToBottom();
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function finishMessage() {
            typingIndicator.classList.remove('active');
            sendBtn.disabled = false;
            updateStatus('–ì–æ—Ç–æ–≤', 'ready');
            currentMessageElement = null;
            accumulatedContent = '';
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function createMessageElement(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? '–í—ã' : 'AI';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (type === 'user') {
                messageContent.textContent = content;
            } else {
                messageContent.innerHTML = MarkdownProcessor.parse(content);
                MarkdownProcessor.highlightCode(messageContent);
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
                setTimeout(() => {
                    if (typeof ClipboardManager !== 'undefined') {
                        messageContent.querySelectorAll('pre').forEach(pre => {
                            ClipboardManager.showCopyButton(pre);
                        });
                    }
                }, 100);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            // –£–¥–∞–ª—è–µ–º welcome message –µ—Å–ª–∏ –µ—Å—Ç—å
            const welcomeMsg = chatMessages.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            chatMessages.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
            
            return messageDiv;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const prompt = userInput.value.trim();
            if (!prompt || sendBtn.disabled) return;
            
            // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            createMessageElement('user', prompt);
            userInput.value = '';
            adjustTextareaHeight();
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–∞
            currentMessageElement = createMessageElement('assistant', '');
            accumulatedContent = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
            typingIndicator.classList.add('active');
            sendBtn.disabled = true;
            updateStatus('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç...', 'generating');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket –∏–ª–∏ HTTP
            if (ws && ws.isConnected()) {
                ws.send({
                    type: 'chat',
                    prompt: prompt
                });
            } else {
                // Fallback –Ω–∞ HTTP
                await sendViaHTTP(prompt);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ HTTP (fallback)
        async function sendViaHTTP(prompt) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt, stream: true })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                function readChunk() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            finishMessage();
                            return;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') {
                                    finishMessage();
                                    return;
                                }
                                
                                try {
                                    const json = JSON.parse(data);
                                    if (json.content) {
                                        appendToMessage(json.content);
                                    }
                                } catch (e) {
                                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                                }
                            }
                        }
                        
                        readChunk();
                    });
                }
                
                readChunk();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                finishMessage();
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
        function clearChat() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
                if (ws && ws.isConnected()) {
                    ws.send({ type: 'clear' });
                }
                clearChatUI();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                if (typeof ToastManager !== 'undefined') {
                    ToastManager.success('–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
                }
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ UI —á–∞—Ç–∞
        function clearChatUI() {
            const messages = chatMessages.querySelectorAll('.message');
            messages.forEach(msg => msg.remove());
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º welcome message
            const welcomeMsg = document.createElement('div');
            welcomeMsg.className = 'welcome-message';
            welcomeMsg.innerHTML = `
                <div class="welcome-icon">üëã</div>
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                <p>–Ø –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –≤–æ–ø—Ä–æ—Å –æ –∫–æ–¥–µ, –∏ —è –ø–æ–º–æ–≥—É –≤–∞–º!</p>
            `;
            chatMessages.insertBefore(welcomeMsg, typingIndicator);
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message message-error';
            errorDiv.innerHTML = `
                <div class="message-avatar">‚ö†Ô∏è</div>
                <div class="message-content">${escapeHtml(message)}</div>
            `;
            chatMessages.insertBefore(errorDiv, typingIndicator);
            scrollToBottom();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (typeof ToastManager !== 'undefined') {
                ToastManager.error(message);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(text, state) {
            statusText.textContent = text;
            statusDot.className = `status-dot status-${state}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            statusDot.style.animation = state === 'generating' ? 'pulse 2s infinite' : '';
        }

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ textarea
        function adjustTextareaHeight() {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        sendBtn.addEventListener('click', sendMessage);
        clearBtn.addEventListener('click', clearChat);
        
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        userInput.addEventListener('input', adjustTextareaHeight);

        // –ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ
        let searchResults = [];
        let currentSearchIndex = -1;
        
        function initSearch() {
            const searchBar = document.getElementById('searchBar');
            const searchInput = document.getElementById('searchInput');
            const searchToggle = document.getElementById('searchToggle');
            const searchClose = document.getElementById('searchClose');
            const searchPrev = document.getElementById('searchPrev');
            const searchNext = document.getElementById('searchNext');
            const searchCount = document.getElementById('searchCount');
            
            if (!searchBar || !searchInput) return;
            
            function performSearch() {
                const query = searchInput.value.trim().toLowerCase();
                if (!query) {
                    clearSearch();
                    return;
                }
                
                const messages = chatMessages.querySelectorAll('.message-content');
                searchResults = [];
                currentSearchIndex = -1;
                
                messages.forEach((msg, index) => {
                    const text = msg.textContent.toLowerCase();
                    if (text.includes(query)) {
                        searchResults.push({ element: msg, index });
                        msg.classList.add('search-highlight');
                    } else {
                        msg.classList.remove('search-highlight');
                    }
                });
                
                if (searchResults.length > 0) {
                    currentSearchIndex = 0;
                    highlightSearchResult(0);
                    searchCount.textContent = `${currentSearchIndex + 1} / ${searchResults.length}`;
                } else {
                    searchCount.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ';
                }
            }
            
            function highlightSearchResult(index) {
                if (searchResults.length === 0) return;
                
                searchResults.forEach((result, i) => {
                    result.element.classList.toggle('search-active', i === index);
                });
                
                const result = searchResults[index];
                if (result) {
                    result.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    searchCount.textContent = `${index + 1} / ${searchResults.length}`;
                }
            }
            
            function clearSearch() {
                chatMessages.querySelectorAll('.search-highlight, .search-active').forEach(el => {
                    el.classList.remove('search-highlight', 'search-active');
                });
                searchResults = [];
                currentSearchIndex = -1;
                searchCount.textContent = '';
            }
            
            searchToggle?.addEventListener('click', () => {
                searchBar.style.display = searchBar.style.display === 'none' ? 'block' : 'none';
                if (searchBar.style.display === 'block') {
                    searchInput.focus();
                } else {
                    clearSearch();
                }
            });
            
            searchClose?.addEventListener('click', () => {
                searchBar.style.display = 'none';
                clearSearch();
            });
            
            searchInput?.addEventListener('input', debounce(performSearch, 300));
            searchInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (e.ctrlKey || e.metaKey) {
                        if (currentSearchIndex > 0) {
                            currentSearchIndex--;
                            highlightSearchResult(currentSearchIndex);
                        }
                    } else {
                        if (currentSearchIndex < searchResults.length - 1) {
                            currentSearchIndex++;
                            highlightSearchResult(currentSearchIndex);
                        }
                    }
                } else if (e.key === 'Escape') {
                    searchBar.style.display = 'none';
                    clearSearch();
                }
            });
            
            searchPrev?.addEventListener('click', () => {
                if (searchResults.length > 0) {
                    currentSearchIndex = (currentSearchIndex - 1 + searchResults.length) % searchResults.length;
                    highlightSearchResult(currentSearchIndex);
                }
            });
            
            searchNext?.addEventListener('click', () => {
                if (searchResults.length > 0) {
                    currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
                    highlightSearchResult(currentSearchIndex);
                }
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            userInput.focus();
            initSearch();
            
            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
            if (typeof KeyboardShortcuts !== 'undefined') {
                KeyboardShortcuts.register('Ctrl+f', (e) => {
                    e.preventDefault();
                    const searchBar = document.getElementById('searchBar');
                    const searchToggle = document.getElementById('searchToggle');
                    if (searchBar && searchToggle) {
                        searchToggle.click();
                    }
                }, '–ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ');
            }
        });
    </script>
</body>
</html>
