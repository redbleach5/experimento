<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ - AI Code Agent</title>
    
    <!-- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="/static/css/common.css">
    
    <style>
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        body {
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .content {
            padding: 32px;
        }

        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--fg-main);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--fg-main);
            font-size: 14px;
        }

        .form-group .description {
            font-size: 12px;
            color: var(--fg-secondary);
            margin-top: 4px;
            margin-bottom: 8px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            margin-top: 32px;
        }

        .provider-section {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .provider-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="header-content">
                <h1 class="app-title">
                    <span class="title-icon">‚öôÔ∏è</span>
                    <span class="title-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </h1>
                <div class="header-actions">
                    <button class="icon-btn" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                        <span class="theme-icon">üåô</span>
                    </button>
                    <nav class="header-nav">
                        <a href="/" class="nav-btn">
                            <span>üí¨</span>
                            <span>–ß–∞—Ç</span>
                        </a>
                        <a href="/ide" class="nav-btn">
                            <span>üíª</span>
                            <span>IDE</span>
                        </a>
                    </nav>
                </div>
            </div>
        </div>
        
        <div class="container">

        <div class="content">
            <div id="alert-container"></div>
            <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</div>

            <form id="settings-form" style="display: none;">
                <!-- –ú–æ–¥–µ–ª—å -->
                <div class="section">
                    <h2 class="section-title">ü§ñ –ú–æ–¥–µ–ª—å</h2>
                    
                    <div class="form-group">
                        <label for="provider">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
                        <div class="description">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI –º–æ–¥–µ–ª—å—é</div>
                        <select id="provider" name="model.provider">
                            <option value="ollama">Ollama (–ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏)</option>
                            <option value="lmstudio">LM Studio (–ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏)</option>
                            <option value="openai">OpenAI (–æ–±–ª–∞—á–Ω—ã–µ –º–æ–¥–µ–ª–∏)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="custom">–ö–∞—Å—Ç–æ–º–Ω—ã–π API</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="model_name">–ò–º—è –º–æ–¥–µ–ª–∏</label>
                        <div class="description">–ù–∞–ø—Ä–∏–º–µ—Ä: deepseek-coder:6.7b, gpt-4, claude-3-opus</div>
                        <input type="text" id="model_name" name="model.model_name" placeholder="deepseek-coder:6.7b">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="temperature">Temperature</label>
                            <div class="description">–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ (0.0-1.0). –ù–∏–∑–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –±–æ–ª–µ–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</div>
                            <input type="number" id="temperature" name="model.generation.temperature" step="0.1" min="0" max="2" placeholder="0.2">
                        </div>
                        <div class="form-group">
                            <label for="max_tokens">–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤</label>
                            <div class="description">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞</div>
                            <input type="number" id="max_tokens" name="model.generation.max_tokens" min="1" max="32768" placeholder="4096">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="top_p">Top P</label>
                            <div class="description">–Ø–¥–µ—Ä–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ (0.0-1.0)</div>
                            <input type="number" id="top_p" name="model.generation.top_p" step="0.01" min="0" max="1" placeholder="0.95">
                        </div>
                        <div class="form-group">
                            <label for="top_k">Top K</label>
                            <div class="description">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</div>
                            <input type="number" id="top_k" name="model.generation.top_k" min="1" placeholder="40">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="repetition_penalty">Repetition Penalty</label>
                        <div class="description">–®—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (1.0 = –±–µ–∑ —à—Ç—Ä–∞—Ñ–∞, >1.0 = –º–µ–Ω—å—à–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π)</div>
                        <input type="number" id="repetition_penalty" name="model.generation.repetition_penalty" step="0.1" min="0.5" max="2.0" placeholder="1.1">
                    </div>
                </div>

                <!-- –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è) -->
                <div class="section" id="ollama-section">
                    <h2 class="section-title">ü¶ô Ollama</h2>
                    <div class="provider-section">
                        <div class="form-group">
                            <label for="ollama_url">Base URL</label>
                            <div class="description">–ê–¥—Ä–µ—Å API Ollama</div>
                            <input type="url" id="ollama_url" name="ollama.base_url" placeholder="http://localhost:11434">
                        </div>
                        <div class="form-group">
                            <label for="ollama_timeout">Timeout (—Å–µ–∫—É–Ω–¥—ã)</label>
                            <div class="description">–¢–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                            <input type="number" id="ollama_timeout" name="ollama.timeout" min="1" placeholder="300">
                        </div>
                    </div>
                </div>

                <div class="section" id="lmstudio-section">
                    <h2 class="section-title">üéµ LM Studio</h2>
                    <div class="provider-section">
                        <div class="form-group">
                            <label for="lmstudio_url">Base URL</label>
                            <div class="description">–ê–¥—Ä–µ—Å API LM Studio</div>
                            <input type="url" id="lmstudio_url" name="lmstudio.base_url" placeholder="http://localhost:1234">
                        </div>
                        <div class="form-group">
                            <label for="lmstudio_timeout">Timeout (—Å–µ–∫—É–Ω–¥—ã)</label>
                            <div class="description">–¢–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                            <input type="number" id="lmstudio_timeout" name="lmstudio.timeout" min="1" placeholder="300">
                        </div>
                    </div>
                </div>

                <div class="section" id="openai-section">
                    <h2 class="section-title">üîµ OpenAI</h2>
                    <div class="provider-section">
                        <div class="form-group">
                            <label for="openai_url">Base URL</label>
                            <div class="description">–ê–¥—Ä–µ—Å API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: https://api.openai.com/v1)</div>
                            <input type="url" id="openai_url" name="openai.base_url" placeholder="https://api.openai.com/v1">
                        </div>
                        <div class="form-group">
                            <label for="openai_key">API Key</label>
                            <div class="description">–í–∞—à API –∫–ª—é—á (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENAI_API_KEY)</div>
                            <input type="text" id="openai_key" name="openai.api_key" placeholder="sk-...">
                        </div>
                        <div class="form-group">
                            <label for="openai_timeout">Timeout (—Å–µ–∫—É–Ω–¥—ã)</label>
                            <input type="number" id="openai_timeout" name="openai.timeout" min="1" placeholder="300">
                        </div>
                    </div>
                </div>

                <div class="section" id="anthropic-section">
                    <h2 class="section-title">üß† Anthropic (Claude)</h2>
                    <div class="provider-section">
                        <div class="form-group">
                            <label for="anthropic_url">Base URL</label>
                            <div class="description">–ê–¥—Ä–µ—Å API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: https://api.anthropic.com/v1)</div>
                            <input type="url" id="anthropic_url" name="anthropic.base_url" placeholder="https://api.anthropic.com/v1">
                        </div>
                        <div class="form-group">
                            <label for="anthropic_key">API Key</label>
                            <div class="description">–í–∞—à API –∫–ª—é—á (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è ANTHROPIC_API_KEY)</div>
                            <input type="text" id="anthropic_key" name="anthropic.api_key" placeholder="sk-ant-...">
                        </div>
                        <div class="form-group">
                            <label for="anthropic_timeout">Timeout (—Å–µ–∫—É–Ω–¥—ã)</label>
                            <input type="number" id="anthropic_timeout" name="anthropic.timeout" min="1" placeholder="300">
                        </div>
                    </div>
                </div>

                <!-- –ê–≥–µ–Ω—Ç -->
                <div class="section">
                    <h2 class="section-title">ü§ñ –ê–≥–µ–Ω—Ç</h2>
                    
                    <div class="form-group">
                        <label for="max_context_length">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞</label>
                        <div class="description">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ</div>
                        <input type="number" id="max_context_length" name="agent.max_context_length" min="512" max="32768" placeholder="4096">
                    </div>

                    <div class="form-group">
                        <label for="project_root">–ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <div class="description">–ü—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞</div>
                        <input type="text" id="project_root" name="agent.project_root" placeholder=".">
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="load_project_context" name="agent.load_project_context">
                        <label for="load_project_context">–ó–∞–≥—Ä—É–∂–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="save_history" name="agent.save_history">
                        <label for="save_history">–°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–æ–≤</label>
                    </div>

                    <div class="form-group">
                        <label for="system_prompt">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</label>
                        <div class="description">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</div>
                        <textarea id="system_prompt" name="agent.system_prompt" placeholder="–¢—ã –æ–ø—ã—Ç–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç..."></textarea>
                    </div>
                </div>

                <!-- GPU -->
                <div class="section">
                    <h2 class="section-title">üéÆ GPU</h2>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="use_gpu" name="gpu.use_gpu">
                        <label for="use_gpu">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPU</label>
                    </div>

                    <div class="form-group">
                        <label for="max_memory">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å GPU (GB)</label>
                        <div class="description">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º –ø–∞–º—è—Ç–∏ GPU –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</div>
                        <input type="number" id="max_memory" name="gpu.max_memory" min="1" max="128" placeholder="24">
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="use_4bit" name="gpu.use_4bit">
                        <label for="use_4bit">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 4-bit –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ</label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="use_8bit" name="gpu.use_8bit">
                        <label for="use_8bit">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 8-bit –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ</label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="use_flash_attention" name="gpu.use_flash_attention">
                        <label for="use_flash_attention">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Flash Attention (—É—Å–∫–æ—Ä–µ–Ω–∏–µ)</label>
                    </div>
                </div>

                <!-- MCP -->
                <div class="section">
                    <h2 class="section-title">üõ†Ô∏è MCP –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h2>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="mcp_enabled" name="mcp.enabled">
                        <label for="mcp_enabled">–í–∫–ª—é—á–∏—Ç—å MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</label>
                    </div>

                    <div class="form-group">
                        <label for="mcp_max_iterations">–ú–∞–∫—Å–∏–º—É–º –∏—Ç–µ—Ä–∞—Ü–∏–π</label>
                        <div class="description">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</div>
                        <input type="number" id="mcp_max_iterations" name="mcp.max_iterations" min="1" max="20" placeholder="5">
                    </div>
                </div>

                <div class="actions">
                    <button type="button" class="action-btn secondary" onclick="resetForm()">
                        <span>üîÑ</span>
                        <span>–°–±—Ä–æ—Å–∏—Ç—å</span>
                    </button>
                    <button type="submit" class="action-btn primary">
                        <span>üíæ</span>
                        <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </button>
                </div>
            </form>
        </div>
        </div>
    </div>

    <!-- –û–±—â–∏–µ —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="/static/js/common.js"></script>
    
    <!-- –°–∫—Ä–∏–ø—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <script>
        let currentConfig = {};

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                if (data.error) {
                    showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.error, 'error');
                    return;
                }

                currentConfig = data.config || {};
                populateForm(currentConfig);
                document.getElementById('loading').classList.remove('active');
                document.getElementById('settings-form').style.display = 'block';
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
        function populateForm(config) {
            setNestedValue('provider', config.model?.provider || 'ollama');
            setNestedValue('model_name', config.model?.model_name || '');
            setNestedValue('temperature', config.model?.generation?.temperature || 0.2);
            setNestedValue('max_tokens', config.model?.generation?.max_tokens || 4096);
            setNestedValue('top_p', config.model?.generation?.top_p || 0.95);
            setNestedValue('top_k', config.model?.generation?.top_k || 40);
            setNestedValue('repetition_penalty', config.model?.generation?.repetition_penalty || 1.1);

            setNestedValue('ollama_url', config.ollama?.base_url || 'http://localhost:11434');
            setNestedValue('ollama_timeout', config.ollama?.timeout || 300);
            setNestedValue('lmstudio_url', config.lmstudio?.base_url || 'http://localhost:1234');
            setNestedValue('lmstudio_timeout', config.lmstudio?.timeout || 300);
            setNestedValue('openai_url', config.openai?.base_url || 'https://api.openai.com/v1');
            setNestedValue('openai_key', config.openai?.api_key || '');
            setNestedValue('openai_timeout', config.openai?.timeout || 300);
            setNestedValue('anthropic_url', config.anthropic?.base_url || 'https://api.anthropic.com/v1');
            setNestedValue('anthropic_key', config.anthropic?.api_key || '');
            setNestedValue('anthropic_timeout', config.anthropic?.timeout || 300);

            setNestedValue('max_context_length', config.agent?.max_context_length || 4096);
            setNestedValue('project_root', config.agent?.project_root || '.');
            setNestedValue('load_project_context', config.agent?.load_project_context !== false);
            setNestedValue('save_history', config.agent?.save_history !== false);
            setNestedValue('system_prompt', config.agent?.system_prompt || '');

            setNestedValue('use_gpu', config.gpu?.use_gpu !== false);
            setNestedValue('max_memory', config.gpu?.max_memory || 24);
            setNestedValue('use_4bit', config.gpu?.use_4bit || false);
            setNestedValue('use_8bit', config.gpu?.use_8bit || false);
            setNestedValue('use_flash_attention', config.gpu?.use_flash_attention !== false);

            setNestedValue('mcp_enabled', config.mcp?.enabled !== false);
            setNestedValue('mcp_max_iterations', config.mcp?.max_iterations || 5);

            updateProviderSections();
        }

        function setNestedValue(id, value) {
            const element = document.getElementById(id);
            if (!element) return;
            
            if (element.type === 'checkbox') {
                element.checked = value;
            } else {
                element.value = value;
            }
        }

        function updateProviderSections() {
            const provider = document.getElementById('provider').value;
            document.getElementById('ollama-section').style.display = provider === 'ollama' ? 'block' : 'none';
            document.getElementById('lmstudio-section').style.display = provider === 'lmstudio' ? 'block' : 'none';
            document.getElementById('openai-section').style.display = provider === 'openai' ? 'block' : 'none';
            document.getElementById('anthropic-section').style.display = provider === 'anthropic' ? 'block' : 'none';
        }

        document.getElementById('provider').addEventListener('change', updateProviderSections);

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const config = {};
            
            config.model = {
                provider: document.getElementById('provider').value,
                model_name: document.getElementById('model_name').value,
                generation: {
                    temperature: parseFloat(document.getElementById('temperature').value) || 0.2,
                    max_tokens: parseInt(document.getElementById('max_tokens').value) || 4096,
                    top_p: parseFloat(document.getElementById('top_p').value) || 0.95,
                    top_k: parseInt(document.getElementById('top_k').value) || 40,
                    repetition_penalty: parseFloat(document.getElementById('repetition_penalty').value) || 1.1
                }
            };

            const provider = config.model.provider;
            if (provider === 'ollama') {
                config.ollama = {
                    base_url: document.getElementById('ollama_url').value || 'http://localhost:11434',
                    timeout: parseInt(document.getElementById('ollama_timeout').value) || 300
                };
            } else if (provider === 'lmstudio') {
                config.lmstudio = {
                    base_url: document.getElementById('lmstudio_url').value || 'http://localhost:1234',
                    timeout: parseInt(document.getElementById('lmstudio_timeout').value) || 300
                };
            } else if (provider === 'openai') {
                config.openai = {
                    base_url: document.getElementById('openai_url').value || 'https://api.openai.com/v1',
                    api_key: document.getElementById('openai_key').value || '',
                    timeout: parseInt(document.getElementById('openai_timeout').value) || 300
                };
            } else if (provider === 'anthropic') {
                config.anthropic = {
                    base_url: document.getElementById('anthropic_url').value || 'https://api.anthropic.com/v1',
                    api_key: document.getElementById('anthropic_key').value || '',
                    timeout: parseInt(document.getElementById('anthropic_timeout').value) || 300
                };
            }

            config.agent = {
                max_context_length: parseInt(document.getElementById('max_context_length').value) || 4096,
                project_root: document.getElementById('project_root').value || '.',
                load_project_context: document.getElementById('load_project_context').checked,
                save_history: document.getElementById('save_history').checked,
                system_prompt: document.getElementById('system_prompt').value
            };

            config.gpu = {
                use_gpu: document.getElementById('use_gpu').checked,
                max_memory: parseInt(document.getElementById('max_memory').value) || 24,
                use_4bit: document.getElementById('use_4bit').checked,
                use_8bit: document.getElementById('use_8bit').checked,
                use_flash_attention: document.getElementById('use_flash_attention').checked
            };

            config.mcp = {
                enabled: document.getElementById('mcp_enabled').checked,
                max_iterations: parseInt(document.getElementById('mcp_max_iterations').value) || 5
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ config })
                });

                const data = await response.json();
                
                if (data.error) {
                    showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + data.error, 'error');
                } else {
                    showAlert(data.warning || data.message || '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', data.warning ? 'warning' : 'success');
                    currentConfig = config;
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        });

        function resetForm() {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è?')) {
                populateForm(currentConfig);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadSettings();
    </script>
</body>
</html>
